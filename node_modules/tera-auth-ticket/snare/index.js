const https = require('https');
const vm = require('vm');
const { JSDOM, VirtualConsole } = require('jsdom');

module.exports = function snare(callback) {
	let chunkString = '';
	https.get('https://mpsnare.iesnare.com/snare.js', function(res) {
		res.on('data', function(chunk) { chunkString += chunk; });
		
		res.on('end', function() {
			const virtualConsole = new VirtualConsole();
			virtualConsole.on("info", (blackbox) => { callback(null, blackbox); });
			const dom = new JSDOM(`<!DOCTYPE html><script>window.io_install_stm = false; window.io_install_flash = false; function io_bb_callback(blackBoxString, isComplete) { if(isComplete) { console.info(blackBoxString); } }</script>`,{ runScripts: 'dangerously', virtualConsole });
			(new vm.Script(chunkString)).runInContext(dom.getInternalVMContext());
		});
	}).on('error', (e) => {
		callback(e, null);
	});
}